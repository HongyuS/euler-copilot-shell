# 日志管理模块设计

## 方案设计

### 整体方案设计

日志管理模块提供统一的日志记录功能，支持多级别日志、自动清理、控制台输出控制和性能监控。

#### 模块架构

```mermaid
graph TB
    subgraph "日志管理核心"
        A[LogManager<br/>日志管理器] --> B[setup_logging<br/>配置日志系统]
        A --> C[get_logger<br/>获取记录器]
        A --> D[get_latest_logs<br/>获取日志内容]
        A --> E[cleanup_empty_logs<br/>清理空文件]
        A --> F[cleanup_old_logs<br/>清理旧文件]
    end
    
    subgraph "输出控制层"
        G[enable_console_output<br/>启用控制台] --> H[StreamHandler<br/>控制台处理器]
        I[disable_console_output<br/>禁用控制台] --> H
    end
    
    subgraph "文件存储层"
        J[FileHandler<br/>文件处理器] --> K[时间戳日志文件<br/>smart-shell-YYYYMMDD-HHMMSS.log]
        J --> L[日志目录<br/>~/.cache/openEuler Intelligence/logs/]
        J --> M[编码处理<br/>UTF-8]
    end
    
    subgraph "单例管理层"
        N[_LogManagerSingleton<br/>单例管理器] --> O[全局实例<br/>_instance]
        N --> P[公共接口<br/>setup_logging/get_logger]
    end
    
    subgraph "工具函数层"
        Q[log_api_request<br/>API请求日志]
        R[log_exception<br/>异常日志记录]
    end
    
    A --> G
    A --> I
    B --> J
    N --> A
    C --> Q
    C --> R
```

#### 核心功能

1. **多级别日志系统**: 支持 DEBUG、INFO、WARNING、ERROR 四个级别
2. **时间戳文件管理**: 每次启动创建新的时间戳日志文件，避免冲突
3. **TUI 模式兼容**: 动态控制控制台输出，避免干扰 TUI 界面
4. **自动清理机制**: 删除 7 天前的旧日志文件和空日志文件
5. **异常追踪**: 完整的异常堆栈记录和格式化输出
6. **单例模式**: 全局统一的日志管理实例和配置

### 详细设计

#### 日志管理器类设计

```mermaid
classDiagram
    class LogManager {
        -_log_dir: Path
        -_current_log_file: Path
        -_config_manager: ConfigManager
        +enable_console_output() None
        +disable_console_output() None
        +get_logger(name: str) Logger
        +get_latest_logs(max_lines: int) list[str]
        +cleanup_empty_logs() None
        -_setup_logging() None
        -_cleanup_old_logs() None
        -_parse_log_file_date(file: Path) datetime
    }
    
    class _LogManagerSingleton {
        -_instance: LogManager
        +get_instance(config_manager: ConfigManager) LogManager
    }
    
    class UtilityFunctions {
        <<static>>
        +log_api_request(logger, method, url, status_code) None
        +log_exception(logger, message, exc) None
        +setup_logging(config_manager) None
        +get_logger(name) Logger
        +cleanup_empty_logs() None
    }
    
    _LogManagerSingleton --> LogManager
    UtilityFunctions ..> _LogManagerSingleton
```

#### 日志配置流程

```mermaid
flowchart TD
    A[应用启动] --> B[调用 setup_logging]
    B --> C[创建/获取 LogManager 实例]
    C --> D[设置日志目录]
    D --> E[生成时间戳文件名]
    E --> F[获取配置中的日志级别]
    
    F --> G{配置管理器存在?}
    G -->|是| H[读取配置日志级别]
    G -->|否| I[使用默认 INFO 级别]
    
    H --> J[配置根日志记录器]
    I --> J
    
    J --> K[设置文件处理器]
    K --> L[设置日志格式]
    L --> M[配置第三方库日志级别]
    M --> N[清理旧日志文件]
    N --> O[日志系统初始化完成]
```

#### 控制台输出控制

```mermaid
stateDiagram-v2
    [*] --> Initialized: 日志系统初始化
    
    Initialized --> ConsoleEnabled: enable_console_output()
    Initialized --> ConsoleDisabled: disable_console_output()
    
    ConsoleEnabled --> CheckHandler: 检查控制台处理器
    CheckHandler --> AlreadyExists: 处理器已存在
    CheckHandler --> CreateHandler: 处理器不存在
    
    CreateHandler --> AddHandler: 添加控制台处理器
    AddHandler --> ConsoleEnabled: 完成启用
    
    AlreadyExists --> ConsoleEnabled: 保持启用状态
    
    ConsoleDisabled --> RemoveHandlers: 移除控制台处理器
    RemoveHandlers --> CloseHandlers: 关闭处理器
    CloseHandlers --> ConsoleDisabled: 完成禁用
    
    ConsoleEnabled --> ConsoleDisabled: disable_console_output()
    ConsoleDisabled --> ConsoleEnabled: enable_console_output()
```

#### 文件管理策略

```mermaid
flowchart TD
    A[日志文件管理] --> B[文件命名策略]
    A --> C[清理策略]
    
    B --> D[时间戳格式<br/>YYYYMMDD-HHMMSS]
    B --> E[前缀标识<br/>smart-shell-]
    B --> F[文件扩展名<br/>.log]
    
    C --> G[启动时清理]
    C --> H[退出时清理]
    
    G --> I{文件修改时间}
    I -->|> 7天| J[删除旧文件]
    I -->|<= 7天| K[保留文件]
    
    H --> L{文件大小}
    L -->|= 0字节| M[删除空文件]
    L -->|> 0字节| N[保留文件]
    
    subgraph "文件位置"
        O[~/.cache/openEuler Intelligence/logs/]
        P[smart-shell-20250808-143022.log]
        Q[smart-shell-20250807-095511.log]
    end
```

#### 异常处理与日志记录

```mermaid
sequenceDiagram
    participant A as 应用代码
    participant L as Logger
    participant F as FileHandler
    participant C as ConsoleHandler
    participant D as 日志文件

    A->>L: logger.info("正常信息")
    L->>F: 处理日志记录
    F->>D: 写入文件
    
    Note over A: 发生异常
    A->>L: log_exception(logger, "错误描述", exception)
    L->>L: 格式化异常堆栈
    L->>F: 记录异常信息
    F->>D: 写入详细异常
    
    alt 控制台输出启用
        L->>C: 同时输出到控制台
        C->>C: 显示到终端
    else 控制台输出禁用
        Note over C: 跳过控制台输出
    end
```

#### 日志级别配置

```mermaid
classDiagram
    class LogLevel {
        <<enumeration>>
        DEBUG: "DEBUG"
        INFO: "INFO" 
        WARNING: "WARNING"
        ERROR: "ERROR"
    }
    
    class LoggingConfig {
        +root_level: LogLevel
        +httpx_level: WARNING
        +openai_level: WARNING
        +file_encoding: "utf-8"
        +format_string: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    }
    
    class ThirdPartyLoggers {
        +httpx: Logger
        +openai: Logger
        +set_warning_level() None
    }
    
    LoggingConfig --> LogLevel
    LoggingConfig --> ThirdPartyLoggers
```

#### API 日志记录工具

```mermaid
flowchart LR
    A[API 调用] --> B[log_api_request]
    B --> C[格式化请求信息]
    C --> D[记录请求方法]
    C --> E[记录请求URL]
    C --> F[记录状态码]
    C --> G[记录响应时间]
    C --> H[记录额外参数]
    
    D --> I[生成日志条目]
    E --> I
    F --> I
    G --> I
    H --> I
    
    I --> J[写入日志文件]
```

#### 使用模式与最佳实践

```mermaid
graph TB
    subgraph "应用生命周期"
        A[应用启动] --> B[setup_logging]
        B --> C[disable_console_output<br/>TUI模式]
        C --> D[正常日志记录]
        D --> E[应用退出]
        E --> F[cleanup_empty_logs]
    end
    
    subgraph "日志记录模式"
        G[获取Logger] --> H[记录信息日志]
        G --> I[记录API调用]
        G --> J[记录异常]
        
        H --> K[logger.info/debug/warning/error]
        I --> L[log_api_request]
        J --> M[log_exception]
    end
    
    subgraph "配置集成"
        N[ConfigManager] --> O[日志级别设置]
        O --> P[动态调整日志输出]
    end
```
