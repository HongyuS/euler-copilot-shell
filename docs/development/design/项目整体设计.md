# openEuler Intelligence Smart Shell 项目整体设计

## 方案设计

### 整体方案设计

openEuler Intelligence Smart Shell 是一个基于 Python Textual 框架的智能终端应用，采用插件化架构支持多 LLM 后端，提供命令验证、自然语言处理和 MCP 工具集成功能。

#### 系统架构

```mermaid
graph TB
    subgraph "用户界面层"
        A[TUI 主界面<br/>IntelligentTerminal]
        B[MCP 交互组件<br/>MCPConfirmWidget<br/>MCPParameterWidget]
        C[设置界面<br/>SettingsScreen]
        D[部署助手<br/>DeploymentService]
    end
    
    subgraph "应用逻辑层"
        E[命令处理器<br/>process_command]
        F{命令类型判断}
        G[系统命令执行<br/>execute_command]
        H[后端路由<br/>BackendFactory]
    end
    
    subgraph "后端适配层"
        I[LLM 客户端基类<br/>LLMClientBase]
        J[OpenAI 客户端<br/>OpenAIClient]
        K[Hermes 客户端<br/>HermesChatClient]
        L[MCP 事件处理器<br/>MCPEventHandler]
    end
    
    subgraph "基础设施层"
        M[配置管理<br/>ConfigManager]
        N[日志管理<br/>LogManager]
        O[流式处理<br/>HermesStreamProcessor]
    end
    
    A --> E
    B --> L
    C --> M
    D --> DeploymentResourceManager
    E --> F
    F -->|系统命令| G
    F -->|自然语言| H
    H --> I
    I --> J
    I --> K
    K --> L
    K --> O
    M --> H
    N --> E
```

#### 核心模块

1. **TUI 应用模块** (`app/`)
   - 基于 Textual 的主界面和交互组件
   - MCP 工具确认和参数输入界面
   - 部署助手界面和设置管理
   - 事件驱动的消息处理机制

2. **后端适配模块** (`backend/`)
   - 抽象基类 `LLMClientBase` 定义统一接口
   - `OpenAIClient` 支持 OpenAI 兼容 API
   - `HermesChatClient` 专用于 openEuler Intelligence
   - MCP 事件处理和流式响应解析

3. **工具处理模块** (`tool/`)
   - 命令安全性验证和系统命令执行
   - 智能化命令建议和错误处理

4. **基础设施模块**
   - 配置持久化存储和动态更新
   - 结构化日志记录和异常追踪

#### 设计原则

- **插件化架构**: 工厂模式实现后端无缝切换
- **事件驱动**: Textual 消息系统处理异步 UI 交互
- **流式优先**: 实时显示 LLM 响应内容
- **配置驱动**: 运行时动态配置和热重载

### 详细设计

#### 类图设计

```mermaid
classDiagram
    class LLMClientBase {
        <<abstract>>
        +get_llm_response(prompt: str) AsyncGenerator[str, None]
        +interrupt() None
        +get_available_models() list[str]
        +reset_conversation() None
        +close() None
    }
    
    class OpenAIClient {
        -base_url: str
        -model: str
        -api_key: str
        +get_llm_response(prompt: str) AsyncGenerator[str, None]
    }
    
    class HermesChatClient {
        -http_manager: HermesHttpManager
        -current_agent_id: str
        -current_task_id: str
        -mcp_handler: MCPEventHandler
        +get_llm_response(prompt: str) AsyncGenerator[str, None]
        +get_available_agents() list[HermesAgent]
        +set_current_agent(agent_id: str) None
        +send_mcp_response(task_id: str, params: bool|dict) AsyncGenerator[str, None]
        +set_mcp_handler(handler: MCPEventHandler) None
        +get_auto_execute_status() bool
        +enable_auto_execute() None
        +disable_auto_execute() None
    }
    
    class BackendFactory {
        <<static>>
        +create_client(config_manager: ConfigManager) LLMClientBase
    }
    
    class IntelligentTerminal {
        -processing: bool
        -llm_client: LLMClientBase
        -mcp_mode: str
        +handle_input(event: Input.Submitted) None
        +get_llm_client() LLMClientBase
        +action_settings() None
        +action_reset_conversation() None
    }
    
    class ConfigManager {
        -data: ConfigModel
        -config_path: Path
        +get_backend() Backend
        +set_backend(backend: Backend) None
        +get_base_url() str
        +set_base_url(url: str) None
    }
    
    LLMClientBase <|-- OpenAIClient
    LLMClientBase <|-- HermesChatClient
    BackendFactory ..> LLMClientBase
    IntelligentTerminal --> LLMClientBase
    IntelligentTerminal --> ConfigManager
    BackendFactory --> ConfigManager
```

#### 配置数据模型

```mermaid
classDiagram
    class ConfigModel {
        +backend: Backend
        +openai: OpenAIConfig
        +eulerintelli: HermesConfig
        +log_level: LogLevel
        +to_dict() dict
        +from_dict(data: dict) ConfigModel
    }
    
    class OpenAIConfig {
        +base_url: str
        +model: str
        +api_key: str
    }
    
    class HermesConfig {
        +base_url: str
        +api_key: str
        +default_app: str
    }
    
    class Backend {
        <<enumeration>>
        OPENAI
        EULERINTELLI
    }
    
    class LogLevel {
        <<enumeration>>
        DEBUG
        INFO
        WARNING
        ERROR
    }
    
    ConfigModel --> OpenAIConfig
    ConfigModel --> HermesConfig
    ConfigModel --> Backend
    ConfigModel --> LogLevel
```

配置文件位置: `~/.config/eulerintelli/smart-shell.json`

#### 命令处理流程

```mermaid
flowchart TD
    A[用户输入命令] --> B{检查命令类型}
    B -->|系统命令| C[检查命令是否存在于PATH]
    B -->|自然语言| D[直接发送给LLM]
    
    C -->|存在| E{安全性检查}
    C -->|不存在| D
    
    E -->|安全| F[执行系统命令]
    E -->|不安全| G[阻止执行并提示]
    
    F -->|成功| H[显示命令输出]
    F -->|失败| I[将错误发送给LLM]
    
    D --> J[LLM 流式响应]
    I --> J
    J --> K[显示 Markdown 格式回答]
    
    H --> L[等待下次输入]
    K --> L
    G --> L
```

#### MCP 工具集成时序图

```mermaid
sequenceDiagram
    participant U as 用户
    participant TUI as IntelligentTerminal
    participant H as HermesChatClient
    participant SP as HermesStreamProcessor
    participant MCP as MCPEventHandler
    participant S as openEuler Intelligence

    U->>TUI: 输入需要工具的问题
    TUI->>H: get_llm_response(prompt)
    H->>S: POST /api/chat
    
    Note over S: 服务端分析需要调用工具
    
    S-->>H: SSE: step.waiting_for_start
    H->>SP: 解析事件
    SP->>MCP: handle_waiting_for_start
    MCP->>TUI: SwitchToMCPConfirm 消息
    TUI->>TUI: 切换到确认界面
    
    U->>TUI: 确认执行工具
    TUI->>H: send_mcp_response(task_id, true)
    H->>S: POST /api/chat (taskId, confirmed)
    
    Note over S: 执行工具并获取结果
    
    S-->>H: SSE: 流式文本响应
    H->>TUI: 逐步显示结果
    TUI->>TUI: 恢复正常输入界面
```

#### 部署助手架构设计

```mermaid
flowchart TD
    A[用户配置输入] --> B[DeploymentService]
    B --> C[检查系统环境]
    
    C --> D{openEuler 系统?}
    D -->|否| E[部署失败]
    D -->|是| F[检查安装器资源]
    
    F --> G{资源完整?}
    G -->|否| H[提示安装 RPM 包]
    G -->|是| I[检查管理员权限]
    
    I --> J{有权限?}
    J -->|否| K[权限错误]
    J -->|是| L[DeploymentResourceManager]
    
    L --> M[更新 env 配置]
    L --> N[更新 config.toml]
    L --> O[设置部署模式]
    
    M --> P[执行部署脚本]
    N --> P
    O --> P
    
    P --> Q[实时监控部署进度]
    Q --> R[部署完成]
    
    subgraph "配置验证器"
        S[LLM 连接验证]
        T[Embedding 配置验证]
        U[系统环境验证]
    end
    
    A --> S
    A --> T
    A --> U
```

#### 核心交互流程

```mermaid
stateDiagram-v2
    [*] --> Normal: 应用启动
    
    Normal --> ProcessingCommand: 用户输入
    ProcessingCommand --> SystemCommand: 检测到系统命令
    ProcessingCommand --> LLMQuery: 检测到自然语言
    ProcessingCommand --> MCPInteraction: LLM 需要工具
    
    SystemCommand --> CommandSafe: 安全检查
    CommandSafe --> ExecuteCommand: 通过检查
    CommandSafe --> BlockCommand: 不安全命令
    ExecuteCommand --> Normal: 执行完成
    BlockCommand --> Normal: 显示警告
    
    LLMQuery --> StreamResponse: LLM 流式响应
    StreamResponse --> Normal: 响应完成
    
    MCPInteraction --> MCPConfirm: 等待用户确认
    MCPInteraction --> MCPParameter: 等待参数输入
    MCPConfirm --> MCPExecute: 用户确认
    MCPConfirm --> Normal: 用户取消
    MCPParameter --> MCPExecute: 参数提供
    MCPParameter --> Normal: 用户取消
    MCPExecute --> StreamResponse: 工具执行结果
    
    Normal --> [*]: 应用退出
```

#### 流式数据处理

```mermaid
flowchart TD
    A[服务端 SSE 流] --> B[HermesStreamEvent]
    B --> C{事件类型解析}
    
    C -->|text.delta| D[累积文本内容]
    C -->|step.waiting_for_start| E[触发确认界面]
    C -->|step.waiting_for_param| F[触发参数界面]
    C -->|step.running| G[显示工具状态]
    C -->|error| H[显示错误信息]
    
    D --> I[MarkdownOutputLine]
    E --> J[MCPConfirmWidget]
    F --> K[MCPParameterWidget]
    G --> L[OutputLine]
    H --> L
    
    I --> M[实时 UI 更新]
    J --> N[用户交互响应]
    K --> N
    L --> M
    
    N --> O[send_mcp_response]
    O --> A
```

#### 部署流程状态机

```mermaid
stateDiagram-v2
    [*] --> CheckEnvironment: 开始部署
    
    CheckEnvironment --> CheckOS: 检查操作系统
    CheckOS --> CheckInstaller: openEuler 系统
    CheckOS --> Failed: 非 openEuler 系统
    
    CheckInstaller --> CheckPermission: 安装器资源可用
    CheckInstaller --> Failed: 缺少安装器
    
    CheckPermission --> GenerateConfig: 有管理员权限
    CheckPermission --> Failed: 权限不足
    
    GenerateConfig --> UpdateEnv: 开始配置生成
    UpdateEnv --> UpdateToml: env 文件更新完成
    UpdateToml --> SetupMode: config.toml 更新完成
    
    SetupMode --> RunDeploy: 部署模式设置完成
    RunDeploy --> MonitorProgress: 开始执行脚本
    
    MonitorProgress --> Success: 部署脚本成功
    MonitorProgress --> Failed: 部署脚本失败
    
    Success --> [*]
    Failed --> [*]
```

#### 关键数据结构

```mermaid
classDiagram
    class HermesStreamEvent {
        +event_type: str
        +step_name: str
        +content: dict
        +get_text_content() str
        +get_step_name() str
        +get_task_id() str
        +from_line(line: str) HermesStreamEvent
    }
    
    class DeploymentConfig {
        +enable_web: bool
        +enable_rag: bool
        +llm: LLMConfig
        +embedding: EmbeddingConfig
        +deployment_mode: str
    }
    
    class DeploymentState {
        +is_running: bool
        +is_completed: bool
        +is_failed: bool
        +current_step: int
        +total_steps: int
        +current_step_name: str
        +logs: list[str]
        +error_message: str
        +add_log(message: str) None
        +reset() None
    }
    
    class AgentInitStatus {
        <<enumeration>>
        SUCCESS
        SKIPPED
        FAILED
    }
    
    class MCPConfirmResult {
        +task_id: str
        +confirmed: bool
    }
    
    class MCPParameterResult {
        +task_id: str
        +params: dict|None
    }
```
