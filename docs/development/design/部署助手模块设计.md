# 部署助手模块设计

## 方案设计

### 整体方案设计

部署助手模块提供可视化的 openEuler Intelligence 后端部署功能，支持环境检测、配置验证、自动部署和进度监控。

#### 模块架构

```mermaid
graph TB
    subgraph "用户界面层"
        A[DeploymentConfigScreen<br/>配置收集界面] --> B[表单输入与验证提示]
        C[DeploymentProgressScreen<br/>部署进度界面] --> D[进度信息与日志输出]
        E[ErrorMessageScreen<br/>错误提示界面] --> F[错误详情展示]
    end
    
    subgraph "业务逻辑层"
        G[DeploymentService<br/>部署服务] --> H[依赖检查<br/>check_and_install_dependencies]
        G --> I[部署执行<br/>deploy]
        G --> J[脚本调度<br/>_run_env_check_script 等]
        G --> K[状态更新<br/>DeploymentState]
    end
    
    subgraph "验证支持层"
        L[DeploymentConfig<br/>配置模型] --> M[LLM 连接验证<br/>validate_llm_connectivity]
        L --> N[Embedding 验证<br/>validate_embedding_connectivity]
        L --> O[参数合法性检查<br/>validate]
        L --> P[APIValidator<br/>工具模块]
    end
    
    subgraph "资源管理层"
        Q[DeploymentResourceManager<br/>资源管理器] --> R[模板文件处理<br/>get_template_content]
        Q --> S[安装器路径管理<br/>INSTALLER_BASE_PATH]
        Q --> T[配置文件更新<br/>update_config_values]
    end
    
    subgraph "数据模型层"
        U[DeploymentState<br/>部署状态]
        V[AgentInitStatus<br/>智能体初始化状态]
    end
    
    A --> G
    C --> G
    E --> A
    G --> Q
    G --> U
    G --> V
    L --> P
```

#### 核心组件

1. **界面组件** (`ui.py`)
   - 配置收集界面和表单验证
   - 部署进度实时显示
   - 验证结果和错误处理界面

2. **部署服务** (`service.py`)
   - 部署流程编排和状态管理
   - 依赖预检查与权限验证（`check_and_install_dependencies`）
   - 配置生成、脚本执行与 Agent 初始化

3. **API 验证器** (`tool/validators.py`)
   - LLM 与 Embedding API 连接测试
   - 多种 function_call/结构化输出能力探测
   - 为配置模型提供异步校验支持

4. **数据模型** (`models.py`)
   - 强类型的配置数据结构
   - 部署状态和进度追踪
   - 验证结果和错误信息

### 详细设计

#### 数据模型设计

```mermaid
classDiagram
    class DeploymentConfig {
        +deployment_mode: str
        +llm: LLMConfig
        +embedding: EmbeddingConfig
        +enable_web: bool
        +enable_rag: bool
        +detected_backend_type: str
        +validate() tuple[bool, list[str]]
        +to_dict() dict
        +from_dict(data: dict) DeploymentConfig
    }
    
    class LLMConfig {
        +endpoint: str
        +api_key: str
        +model: str
        +max_tokens: int
        +temperature: float
        +request_timeout: int
        +validate_url() bool
        +validate_model() bool
    }
    
    class EmbeddingConfig {
        +type: str
        +endpoint: str
        +api_key: str
        +model: str
        +validate_type() bool
        +validate_endpoint() bool
    }
    
    class DeploymentState {
        +current_step: int
        +total_steps: int
        +current_step_name: str
        +is_running: bool
        +is_completed: bool
        +is_failed: bool
        +error_message: str
        +output_log: list[str]
        +add_log(message: str) None
        +reset() None
    }
    
    class AgentInitStatus {
        <<enumeration>>
        SUCCESS
        SKIPPED
        FAILED
    }
    
    DeploymentConfig --> LLMConfig
    DeploymentConfig --> EmbeddingConfig
```

#### 部署流程状态机

```mermaid
stateDiagram-v2
    [*] --> Initializing: 开始部署
    
    Initializing --> CheckingEnvironment: 初始化完成
    CheckingEnvironment --> CheckingOS: 环境检查开始
    
    CheckingOS --> CheckingInstaller: openEuler 系统
    CheckingOS --> EnvironmentError: 非支持系统
    
    CheckingInstaller --> CheckingPermissions: 安装器资源完整
    CheckingInstaller --> InstallerError: 缺少安装器
    
    CheckingPermissions --> GeneratingConfig: 权限验证通过
    CheckingPermissions --> PermissionError: 权限不足
    
    GeneratingConfig --> UpdatingEnv: 开始生成配置
    UpdatingEnv --> UpdatingToml: env 文件更新完成
    UpdatingToml --> SettingMode: config.toml 更新完成
    
    SettingMode --> ExecutingScript: 部署模式设置完成
    ExecutingScript --> MonitoringProgress: 脚本开始执行
    
    MonitoringProgress --> DeploymentComplete: 脚本执行成功
    MonitoringProgress --> ScriptError: 脚本执行失败
    
    DeploymentComplete --> [*]: 部署成功
    
    EnvironmentError --> [*]: 环境错误退出
    InstallerError --> [*]: 安装器错误退出
    PermissionError --> [*]: 权限错误退出
    ScriptError --> [*]: 脚本错误退出
```

#### 配置验证流程

```mermaid
flowchart TD
    A[用户提交配置] --> B[基础格式验证]
    B --> C{格式检查通过?}
    
    C -->|否| D[显示格式错误]
    C -->|是| E[LLM 连接验证]
    
    E --> F[发送测试请求]
    F --> G{LLM 响应正常?}
    
    G -->|否| H[LLM 连接失败]
    G -->|是| I[Embedding 连接验证]
    
    I --> J[发送 embedding 测试]
    J --> K{Embedding 响应正常?}
    
    K -->|否| L[Embedding 连接失败]
    K -->|是| M[验证全部通过]
    
    D --> N[阻止部署]
    H --> N
    L --> N
    
    M --> O[允许开始部署]
```

#### 部署服务架构

```mermaid
classDiagram
    class DeploymentService {
        +state: DeploymentState
        -_process: Process
        +resource_manager: DeploymentResourceManager
        +check_and_install_dependencies(callback: Callable) tuple[bool, list[str]]
        +detect_openeuler() bool
        +check_python_version_for_deployment(mode: str) tuple[bool, str]
        +check_sudo_privileges() bool
        +deploy(config: DeploymentConfig, callback: Callable) bool
        +cancel_deployment() None
        -_execute_deployment_steps(config, callback) bool
        -_setup_deploy_mode(config, callback) bool
        -_check_environment(config, callback) bool
        -_generate_config_files(config, callback) bool
        -_run_env_check_script(config, callback) bool
        -_run_install_dependency_script(config, callback) bool
        -_run_agent_init(config, callback) bool
        -_create_global_config_template(config) None
        -_update_backend_url_config(config) None
    }
    
    class DeploymentResourceManager {
        +INSTALLER_BASE_PATH: Path
        +RESOURCE_PATH: Path
        +DEPLOY_SCRIPT: Path
        +ENV_TEMPLATE: Path
        +CONFIG_TEMPLATE: Path
        +INSTALL_MODE_FILE: Path
        +check_installer_available() bool
        +get_template_content(path: Path) str
        +update_config_values(content: str, config: DeploymentConfig) str
        +update_toml_values(content: str, config: DeploymentConfig) str
        +create_deploy_mode_content(config: DeploymentConfig) str
    }
    
    DeploymentService --> DeploymentResourceManager
    DeploymentService --> DeploymentState
```

#### 验证器设计

```mermaid
classDiagram
    class APIValidator {
        +validate_llm_config(endpoint: str, api_key: str, model: str, timeout: int, max_tokens: int|None, temperature: float|None) tuple[bool, str, dict]
        +validate_embedding_config(endpoint: str, api_key: str, model: str, timeout: int) tuple[bool, str, dict]
    }
    
    class DeploymentConfig {
        +validate_llm_connectivity() tuple[bool, str, dict]
        +validate_embedding_connectivity() tuple[bool, str, dict]
    }
    
    DeploymentConfig --> APIValidator
```

#### 用户界面组件

```mermaid
graph LR
    subgraph "配置收集界面"
        A[DeploymentConfigScreen] --> B[服务器配置区]
        A --> C[LLM配置区]
        A --> D[Embedding配置区]
        A --> E[部署选项区]
        A --> F[操作按钮区]
    end
    
    subgraph "进度显示界面"
        G[DeploymentProgressScreen] --> H[步骤进度条]
        G --> I[当前状态显示]
        G --> J[实时日志滚动]
        G --> K[操作控制按钮]
    end
    
    subgraph "消息提示界面"
        L[ErrorMessageScreen] --> M[错误信息列表]
        L --> N[返回配置按钮]
    end
```

#### 异步任务管理

```mermaid
sequenceDiagram
    participant U as 用户界面
    participant S as DeploymentService
    participant R as ResourceManager
    participant P as 系统进程

    U->>S: 开始部署(config, callback)
    S->>S: 重置状态
    S->>U: 回调(检查环境状态)
    
    S->>S: _check_environment()
    S->>U: 回调(环境检查完成)
    
    S->>R: get_template_content()
    R->>S: 返回模板内容
    S->>R: update_config_values()
    R->>S: 返回更新后配置
    S->>U: 回调(配置生成完成)
    
    S->>P: 启动部署脚本
    loop 监控部署进程
        P-->>S: 输出日志行
        S->>U: 回调(日志更新)
    end
    P->>S: 进程结束
    S->>U: 回调(部署完成)
```

#### 错误处理策略

```mermaid
flowchart TD
    A[操作执行] --> B{是否发生异常?}
    
    B -->|否| C[正常执行完成]
    B -->|是| D[捕获异常类型]
    
    D --> E{网络相关?}
    D --> F{权限相关?}
    D --> G{文件操作?}
    D --> H{其他异常?}
    
    E -->|是| I[网络连接错误<br/>提供重试选项]
    F -->|是| J[权限不足错误<br/>提示提升权限]
    G -->|是| K[文件操作错误<br/>检查路径和权限]
    H -->|是| L[通用错误处理<br/>记录详细日志]
    
    I --> M[更新状态为失败]
    J --> M
    K --> M
    L --> M
    
    M --> N[通过回调通知界面]
    N --> O[显示错误信息给用户]
    
    C --> P[通过回调通知成功]
```
