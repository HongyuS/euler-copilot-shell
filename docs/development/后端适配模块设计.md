# 后端适配模块设计

## 方案设计

### 整体方案设计

后端适配模块提供统一的 LLM 客户端接口，支持多种后端实现。采用抽象基类和工厂模式，确保接口一致性和可扩展性。

#### 模块架构

```mermaid
graph TB
    subgraph "抽象接口层"
        A[LLMClientBase<br/>抽象基类] --> B[get_llm_response<br/>流式响应]
        A --> C[get_available_models<br/>模型列表]
        A --> D[reset_conversation<br/>重置对话]
        A --> E[close<br/>关闭连接]
    end
    
    subgraph "实现层"
        F[OpenAIClient<br/>OpenAI兼容] -.-> A
        G[HermesChatClient<br/>Hermes专用] -.-> A
    end
    
    subgraph "工厂层"
        H[BackendFactory<br/>客户端工厂] --> I[create_client<br/>创建客户端]
        I --> F
        I --> G
    end
    
    subgraph "Hermes服务层"
        G --> J[HermesHttpManager<br/>HTTP管理]
        G --> K[HermesAgentManager<br/>智能体管理]
        G --> L[HermesConversationManager<br/>会话管理]
        G --> M[HermesModelManager<br/>模型管理]
        G --> N[HermesStreamProcessor<br/>流处理]
    end
    
    subgraph "MCP处理层"
        O[MCPEventHandler<br/>事件处理器] --> P[handle_waiting_for_start<br/>确认处理]
        O --> Q[handle_waiting_for_param<br/>参数处理]
        G --> O
    end
    
    subgraph "配置管理"
        R[ConfigManager<br/>配置管理] --> H
    end
```

#### 核心组件

1. **抽象基类** (`base.py`)
   - 定义统一的客户端接口规范
   - 提供异步上下文管理器支持
   - 确保接口一致性

2. **OpenAI 客户端** (`openai.py`)
   - 兼容 OpenAI API 的标准实现
   - 支持对话历史管理
   - 流式响应处理

3. **Hermes 客户端** (`hermes/`)
   - 专为 openEuler Intelligence 设计
   - 完整的 MCP 工具支持
   - 智能体管理和会话持久化
   - 模块化服务管理

4. **工厂类** (`factory.py`)
   - 根据配置动态创建客户端
   - 统一的客户端创建接口

### 详细设计

#### 抽象基类设计

```mermaid
classDiagram
    class LLMClientBase {
        <<abstract>>
        +get_llm_response(prompt: str) AsyncGenerator[str, None]
        +interrupt() None
        +get_available_models() list[str]
        +reset_conversation() None
        +close() None
        +__aenter__() Self
        +__aexit__() None
    }
    
    class OpenAIClient {
        -client: AsyncOpenAI
        -model: str
        -conversation_history: list
        +get_llm_response(prompt: str) AsyncGenerator[str, None]
        +get_available_models() list[str]
        +reset_conversation() None
        +close() None
    }
    
    class HermesChatClient {
        -http_manager: HermesHttpManager
        -current_agent_id: str
        -current_task_id: str
        -mcp_handler: MCPEventHandler
        -user_manager: HermesUserManager
        -model_manager: HermesModelManager
        -agent_manager: HermesAgentManager
        -conversation_manager: HermesConversationManager
        -stream_processor: HermesStreamProcessor
        +get_llm_response(prompt: str) AsyncGenerator[str, None]
        +get_available_models() list[str]
        +get_available_agents() list[HermesAgent]
        +set_mcp_handler(handler: MCPEventHandler) None
        +set_current_agent(agent_id: str) None
        +send_mcp_response(task_id: str, params: bool|dict) AsyncGenerator[str, None]
        +get_auto_execute_status() bool
        +enable_auto_execute() None
        +disable_auto_execute() None
    }
    
    LLMClientBase <|-- OpenAIClient
    LLMClientBase <|-- HermesChatClient
```

#### Hermes 客户端服务架构

```mermaid
graph LR
    subgraph "客户端核心"
        A[HermesChatClient] --> B[延迟初始化管理器]
    end
    
    subgraph "HTTP层"
        C[HermesHttpManager] --> D[httpx.AsyncClient]
        C --> E[请求头管理]
        C --> F[连接池管理]
    end
    
    subgraph "业务服务层"
        G[HermesAgentManager] --> H[智能体列表获取]
        G --> I[分页处理]
        J[HermesConversationManager] --> K[会话创建]
        J --> L[会话停止]
        M[HermesModelManager] --> N[模型列表获取]
        O[HermesStreamProcessor] --> P[SSE事件解析]
        O --> Q[特殊事件处理]
    end
    
    A --> C
    A --> G
    A --> J
    A --> M
    A --> O
```

#### MCP 事件处理流程

```mermaid
stateDiagram-v2
    [*] --> Streaming: 开始流式处理
    
    Streaming --> ParseEvent: 解析SSE事件
    ParseEvent --> TextEvent: text.delta事件
    ParseEvent --> WaitingStart: step.waiting_for_start
    ParseEvent --> WaitingParam: step.waiting_for_param
    ParseEvent --> StepRunning: step.running
    ParseEvent --> ErrorEvent: error事件
    
    TextEvent --> AccumulateText: 累积文本内容
    AccumulateText --> Streaming: 继续处理
    
    WaitingStart --> TriggerConfirm: 触发确认界面
    TriggerConfirm --> WaitUserConfirm: 等待用户确认
    WaitUserConfirm --> SendResponse: 发送MCP响应
    
    WaitingParam --> TriggerParam: 触发参数界面
    TriggerParam --> WaitUserParam: 等待用户输入
    WaitUserParam --> SendResponse: 发送MCP响应
    
    SendResponse --> Streaming: 继续流式处理
    
    StepRunning --> ShowStatus: 显示状态信息
    ShowStatus --> Streaming: 继续处理
    
    ErrorEvent --> ShowError: 显示错误信息
    ShowError --> [*]: 结束处理
    
    Streaming --> [*]: 流结束
```

#### 工厂模式实现

```mermaid
classDiagram
    class BackendFactory {
        <<static>>
        +create_client(config_manager: ConfigManager) LLMClientBase
    }
    
    class ConfigManager {
        +get_backend() Backend
        +get_base_url() str
        +get_model() str
        +get_api_key() str
        +get_eulerintelli_url() str
        +get_eulerintelli_key() str
    }
    
    class Backend {
        <<enumeration>>
        OPENAI
        EULERINTELLI
    }
    
    BackendFactory --> ConfigManager
    ConfigManager --> Backend
    BackendFactory ..> LLMClientBase
```

#### 流式数据处理设计

```mermaid
sequenceDiagram
    participant C as HermesChatClient
    participant H as HermesHttpManager
    participant S as HermesStreamProcessor
    participant M as MCPEventHandler
    participant T as TUI

    C->>H: 发送聊天请求
    H-->>C: SSE响应流
    C->>S: 解析SSE事件
    
    loop 处理每个事件
        S->>S: 解析事件类型
        alt 文本内容
            S->>C: 返回文本
            C->>T: 显示内容
        else MCP确认事件
            S->>M: handle_waiting_for_start
            M->>T: 切换确认界面
            T->>C: 用户确认响应
        else MCP参数事件
            S->>M: handle_waiting_for_param
            M->>T: 切换参数界面
            T->>C: 用户参数响应
        end
    end
```

#### 异常处理策略

```mermaid
flowchart TD
    A[客户端调用] --> B{网络请求}
    B -->|成功| C[解析响应]
    B -->|失败| D[网络异常处理]
    
    C --> E{响应状态码}
    E -->|200| F[处理SSE流]
    E -->|其他| G[API异常处理]
    
    F --> H{解析事件}
    H -->|成功| I[事件分发]
    H -->|失败| J[数据格式异常]
    
    D --> K[HermesAPIError<br/>网络错误]
    G --> L[HermesAPIError<br/>API错误]
    J --> M[HermesAPIError<br/>解析错误]
    
    K --> N[日志记录]
    L --> N
    M --> N
    N --> O[向上层抛出异常]
```

#### 服务管理器设计

```mermaid
classDiagram
    class HermesUserManager {
        -http_manager: HermesHttpManager
        +get_user_info() dict
        +update_auto_execute(auto_execute: bool) None
    }
    
    class HermesAgentManager {
        -http_manager: HermesHttpManager
        +get_available_agents() list[HermesAgent]
        -_fetch_agents_page(page: int) dict
    }
    
    class HermesConversationManager {
        -http_manager: HermesHttpManager
        -current_conversation_id: str
        +ensure_conversation() str
        +reset_conversation() None
        +stop_conversation() None
        -_create_conversation() str
    }
    
    class HermesModelManager {
        -http_manager: HermesHttpManager
        +get_available_models() list[str]
    }
    
    class HermesStreamProcessor {
        +handle_special_events(event: HermesStreamEvent) tuple[bool, str]
        +format_mcp_status(event: HermesStreamEvent) str
        +get_no_content_message(event_count: int) str
        +log_text_content(content: str) None
    }
```
